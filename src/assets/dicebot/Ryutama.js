/* Generated by Opal 1.0.3 */
(function(Opal) {
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_divide(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs / rhs : lhs['$/'](rhs);
  }
  function $rb_ge(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs >= rhs : lhs['$>='](rhs);
  }
  function $rb_gt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs > rhs : lhs['$>'](rhs);
  }
  function $rb_lt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs < rhs : lhs['$<'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $send = Opal.send, $truthy = Opal.truthy;

  Opal.add_stubs(['$setPrefixes', '$debug', '$===', '$to_i', '$last_match', '$getDiceType', '$==', '$parren_killer', '$+', '$getDiffculty', '$getRollValue', '$getResultText', '$empty?', '$getModifyString', '$getBaseText', '$!=', '$isValidDiceOne', '$isValidDice', '$floor', '$/', '$%', '$include?', '$nil?', '$rand', '$isFamble', '$isCritical', '$>=', '$>', '$to_s', '$<']);
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'Ryutama');

    var $nesting = [self].concat($parent_nesting), $Ryutama_initialize$1, $Ryutama_rollDiceCommand$2, $Ryutama_getDiceType$3, $Ryutama_isValidDice$4, $Ryutama_isValidDiceOne$5, $Ryutama_getDiffculty$6, $Ryutama_getRollValue$7, $Ryutama_getResultText$8, $Ryutama_isFamble$9, $Ryutama_isCritical$10, $Ryutama_getBaseText$11, $Ryutama_getModifyString$12;

    self.$$prototype.validDiceTypes = nil;
    
    Opal.const_set($nesting[0], 'ID', "Ryutama");
    Opal.const_set($nesting[0], 'NAME', "りゅうたま");
    Opal.const_set($nesting[0], 'SORT_KEY', "りゆうたま");
    Opal.const_set($nesting[0], 'HELP_MESSAGE', "" + "・判定\n" + "　Rx,y>=t（x,y：使用する能力値、t：目標値）\n" + "　1ゾロ、クリティカルも含めて判定結果を表示します\n" + "　能力値１つでの判定は Rx>=t で行えます\n" + "例）R8,6>=13\n");
    self.$setPrefixes(["R\\d+.*"]);
    
    Opal.def(self, '$initialize', $Ryutama_initialize$1 = function $$initialize() {
      var $iter = $Ryutama_initialize$1.$$p, $yield = $iter || nil, self = this, $zuper = nil, $zuper_i = nil, $zuper_ii = nil;

      if ($iter) $Ryutama_initialize$1.$$p = null;
      // Prepare super implicit arguments
      for($zuper_i = 0, $zuper_ii = arguments.length, $zuper = new Array($zuper_ii); $zuper_i < $zuper_ii; $zuper_i++) {
        $zuper[$zuper_i] = arguments[$zuper_i];
      }
      
      $send(self, Opal.find_super_dispatcher(self, 'initialize', $Ryutama_initialize$1, false), $zuper, $iter);
      return (self.validDiceTypes = [20, 12, 10, 8, 6, 4, 2]);
    }, $Ryutama_initialize$1.$$arity = 0);
    
    Opal.def(self, '$rollDiceCommand', $Ryutama_rollDiceCommand$2 = function $$rollDiceCommand(command) {
      var $a, $b, self = this, dice1 = nil, dice2 = nil, modifyString = nil, difficulty = nil, modify = nil, value1 = nil, value2 = nil, total = nil, result = nil, value1Text = nil, value2Text = nil, modifyText = nil, baseText = nil, output = nil;

      
      self.$debug("rollDiceCommand begin");
      if ($truthy(/^R(\d+)(,(\d+))?([\+\-\d]+)?(>=(\d+))?/['$==='](command))) {
      } else {
        
        self.$debug("unmatched!");
        return "";
      };
      self.$debug("matched");
      dice1 = $$($nesting, 'Regexp').$last_match(1).$to_i();
      dice2 = $$($nesting, 'Regexp').$last_match(3).$to_i();
      modifyString = $$($nesting, 'Regexp').$last_match(4);
      difficulty = $$($nesting, 'Regexp').$last_match(6);
      $b = self.$getDiceType(dice1, dice2), $a = Opal.to_ary($b), (dice1 = ($a[0] == null ? nil : $a[0])), (dice2 = ($a[1] == null ? nil : $a[1])), $b;
      if (dice1['$=='](0)) {
        return ""};
      modifyString = ($truthy($a = modifyString) ? $a : "");
      modify = self.$parren_killer($rb_plus($rb_plus("(", modifyString), ")")).$to_i();
      difficulty = self.$getDiffculty(difficulty);
      value1 = self.$getRollValue(dice1);
      value2 = self.$getRollValue(dice2);
      total = $rb_plus($rb_plus(value1, value2), modify);
      result = self.$getResultText(value1, value2, dice1, dice2, difficulty, total);
      if ($truthy(result['$empty?']())) {
      } else {
        result = "" + " ＞ " + (result)
      };
      value1Text = "" + (value1) + "(" + (dice1) + ")";
      value2Text = (function() {if (value2['$=='](0)) {
        return ""
      } else {
        return "" + "+" + (value2) + "(" + (dice2) + ")"
      }; return nil; })();
      modifyText = self.$getModifyString(modify);
      baseText = self.$getBaseText(dice1, dice2, modify, difficulty);
      output = "" + "(" + (baseText) + ") ＞ " + (value1Text) + (value2Text) + (modifyText) + " ＞ " + (total) + (result);
      return output;
    }, $Ryutama_rollDiceCommand$2.$$arity = 1);
    
    Opal.def(self, '$getDiceType', $Ryutama_getDiceType$3 = function $$getDiceType(dice1, dice2) {
      var self = this, diceBase = nil;

      
      self.$debug("getDiceType begin");
      if ($truthy(dice2['$!='](0))) {
        if ($truthy(self.$isValidDiceOne(dice1))) {
          return [dice1, dice2]
        } else {
          return [0, 0]
        }};
      if ($truthy(self.$isValidDice(dice1, dice2))) {
        return [dice1, dice2]};
      diceBase = dice1;
      dice1 = $rb_divide(diceBase, 10).$floor();
      dice2 = diceBase['$%'](10);
      if ($truthy(self.$isValidDice(dice1, dice2))) {
        return [dice1, dice2]};
      dice1 = $rb_divide(diceBase, 100).$floor();
      dice2 = diceBase['$%'](100);
      if ($truthy(self.$isValidDice(dice1, dice2))) {
        return [dice1, dice2]};
      if ($truthy(self.$isValidDiceOne(diceBase))) {
        return [diceBase, 0]};
      return [0, 0];
    }, $Ryutama_getDiceType$3.$$arity = 2);
    
    Opal.def(self, '$isValidDice', $Ryutama_isValidDice$4 = function $$isValidDice(dice1, dice2) {
      var $a, self = this;

      return ($truthy($a = self.$isValidDiceOne(dice1)) ? self.$isValidDiceOne(dice2) : $a)
    }, $Ryutama_isValidDice$4.$$arity = 2);
    
    Opal.def(self, '$isValidDiceOne', $Ryutama_isValidDiceOne$5 = function $$isValidDiceOne(dice) {
      var self = this;

      return self.validDiceTypes['$include?'](dice)
    }, $Ryutama_isValidDiceOne$5.$$arity = 1);
    
    Opal.def(self, '$getDiffculty', $Ryutama_getDiffculty$6 = function $$getDiffculty(difficulty) {
      var self = this;

      
      if ($truthy(difficulty['$nil?']())) {
      } else {
        difficulty = difficulty.$to_i()
      };
      return difficulty;
    }, $Ryutama_getDiffculty$6.$$arity = 1);
    
    Opal.def(self, '$getRollValue', $Ryutama_getRollValue$7 = function $$getRollValue(dice) {
      var self = this, value = nil;

      
      if (dice['$=='](0)) {
        return 0};
      value = $rb_plus(self.$rand(dice), 1);
      return value;
    }, $Ryutama_getRollValue$7.$$arity = 1);
    
    Opal.def(self, '$getResultText', $Ryutama_getResultText$8 = function $$getResultText(value1, value2, dice1, dice2, difficulty, total) {
      var self = this;

      
      if ($truthy(self.$isFamble(value1, value2))) {
        return "１ゾロ【１ゾロポイント＋１】"};
      if ($truthy(self.$isCritical(value1, value2, dice1, dice2))) {
        return "クリティカル成功"};
      if ($truthy(difficulty['$nil?']())) {
        return ""};
      if ($truthy($rb_ge(total, difficulty))) {
        return "成功"};
      return "失敗";
    }, $Ryutama_getResultText$8.$$arity = 6);
    
    Opal.def(self, '$isFamble', $Ryutama_isFamble$9 = function $$isFamble(value1, value2) {
      var $a, self = this;

      return ($truthy($a = value1['$=='](1)) ? value2['$=='](1) : $a)
    }, $Ryutama_isFamble$9.$$arity = 2);
    
    Opal.def(self, '$isCritical', $Ryutama_isCritical$10 = function $$isCritical(value1, value2, dice1, dice2) {
      var $a, self = this;

      
      if (value2['$=='](0)) {
        return false};
      if ($truthy(($truthy($a = value1['$=='](6)) ? value2['$=='](6) : $a))) {
        return true};
      if ($truthy(($truthy($a = value1['$=='](dice1)) ? value2['$=='](dice2) : $a))) {
        return true};
      return false;
    }, $Ryutama_isCritical$10.$$arity = 4);
    
    Opal.def(self, '$getBaseText', $Ryutama_getBaseText$11 = function $$getBaseText(dice1, dice2, modify, difficulty) {
      var self = this, baseText = nil;

      
      baseText = "" + "R" + (dice1);
      if ($truthy(dice2['$!='](0))) {
        baseText = $rb_plus(baseText, "" + "," + (dice2))};
      baseText = $rb_plus(baseText, self.$getModifyString(modify));
      if ($truthy(difficulty['$nil?']())) {
      } else {
        baseText = $rb_plus(baseText, "" + ">=" + (difficulty))
      };
      return baseText;
    }, $Ryutama_getBaseText$11.$$arity = 4);
    return (Opal.def(self, '$getModifyString', $Ryutama_getModifyString$12 = function $$getModifyString(modify) {
      var self = this;

      
      if ($truthy($rb_gt(modify, 0))) {
        return $rb_plus("+", modify.$to_s())
      } else if ($truthy($rb_lt(modify, 0))) {
        return modify.$to_s()};
      return "";
    }, $Ryutama_getModifyString$12.$$arity = 1), nil) && 'getModifyString';
  })($nesting[0], $$($nesting, 'DiceBot'), $nesting)
})(Opal);
