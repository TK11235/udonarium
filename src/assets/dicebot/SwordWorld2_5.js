/* Generated by Opal 1.0.3 */
Opal.modules["utils/ArithmeticEvaluator"] = function(Opal) {
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_minus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs - rhs : lhs['$-'](rhs);
  }
  function $rb_times(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs * rhs : lhs['$*'](rhs);
  }
  function $rb_divide(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs / rhs : lhs['$/'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $truthy = Opal.truthy, $send = Opal.send;

  Opal.add_stubs(['$tokenize', '$expr', '$private', '$split', '$gsub', '$mul', '$loop', '$consume', '$+', '$-', '$unary', '$*', '$div', '$zero?', '$===', '$ceil', '$/', '$to_f', '$round', '$floor', '$-@', '$term', '$expect', '$expect_number', '$!=', '$[]', '$integer?', '$to_i', '$!', '$nil?', '$match']);
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'ArithmeticEvaluator');

    var $nesting = [self].concat($parent_nesting), $ArithmeticEvaluator_eval$1, $ArithmeticEvaluator_tokenize$2, $ArithmeticEvaluator_add$4, $ArithmeticEvaluator_mul$6, $ArithmeticEvaluator_div$8, $ArithmeticEvaluator_unary$9, $ArithmeticEvaluator_term$10, $ArithmeticEvaluator_consume$11, $ArithmeticEvaluator_expect$12, $ArithmeticEvaluator_expect_number$13, $ArithmeticEvaluator_integer$ques$14;

    self.$$prototype.error = self.$$prototype.round_type = self.$$prototype.tokens = self.$$prototype.idx = nil;
    
    
    Opal.def(self, '$eval', $ArithmeticEvaluator_eval$1 = function(expr, round_type) {
      var self = this, ret = nil;

      
      
      if (round_type == null) {
        round_type = "omit";
      };
      self.tokens = self.$tokenize(expr);
      self.idx = 0;
      self.error = false;
      self.round_type = round_type;
      ret = self.$expr();
      if ($truthy(self.error)) {
        return 0
      } else {
        return ret
      };
    }, $ArithmeticEvaluator_eval$1.$$arity = -2);
    self.$private();
    
    Opal.def(self, '$tokenize', $ArithmeticEvaluator_tokenize$2 = function $$tokenize(expr) {
      var $$3, self = this;

      return $send(expr, 'gsub', [/[\(\)\+\-\*\/]/], ($$3 = function(e){var self = $$3.$$s || this;

      
        
        if (e == null) {
          e = nil;
        };
        return "" + " " + (e) + " ";}, $$3.$$s = self, $$3.$$arity = 1, $$3)).$split(" ")
    }, $ArithmeticEvaluator_tokenize$2.$$arity = 1);
    
    Opal.def(self, '$add', $ArithmeticEvaluator_add$4 = function $$add() {
      var $$5, self = this, ret = nil;

      
      ret = self.$mul();
      (function(){var $brk = Opal.new_brk(); try {return $send(self, 'loop', [], ($$5 = function(){var self = $$5.$$s || this;

      if ($truthy(self.$consume("+"))) {
          return (ret = $rb_plus(ret, self.$mul()))
        } else if ($truthy(self.$consume("-"))) {
          return (ret = $rb_minus(ret, self.$mul()))
        } else {
          
          Opal.brk(nil, $brk)
        }}, $$5.$$s = self, $$5.$$brk = $brk, $$5.$$arity = 0, $$5))
      } catch (err) { if (err === $brk) { return err.$v } else { throw err } }})();
      return ret;
    }, $ArithmeticEvaluator_add$4.$$arity = 0);
    Opal.alias(self, "expr", "add");
    
    Opal.def(self, '$mul', $ArithmeticEvaluator_mul$6 = function $$mul() {
      var $$7, self = this, ret = nil;

      
      ret = self.$unary();
      (function(){var $brk = Opal.new_brk(); try {return $send(self, 'loop', [], ($$7 = function(){var self = $$7.$$s || this;

      if ($truthy(self.$consume("*"))) {
          return (ret = $rb_times(ret, self.$unary()))
        } else if ($truthy(self.$consume("/"))) {
          return (ret = self.$div(ret, self.$unary()))
        } else {
          
          Opal.brk(nil, $brk)
        }}, $$7.$$s = self, $$7.$$brk = $brk, $$7.$$arity = 0, $$7))
      } catch (err) { if (err === $brk) { return err.$v } else { throw err } }})();
      return ret;
    }, $ArithmeticEvaluator_mul$6.$$arity = 0);
    
    Opal.def(self, '$div', $ArithmeticEvaluator_div$8 = function $$div(left, right) {
      var self = this, $case = nil;

      
      if ($truthy(right['$zero?']())) {
        
        self.error = true;
        return 0;};
      return (function() {$case = self.round_type;
      if ("roundUp"['$===']($case)) {return $rb_divide(left.$to_f(), right).$ceil()}
      else if ("roundOff"['$===']($case)) {return $rb_divide(left.$to_f(), right).$round()}
      else {return $rb_divide(left, right).$floor()}})();
    }, $ArithmeticEvaluator_div$8.$$arity = 2);
    
    Opal.def(self, '$unary', $ArithmeticEvaluator_unary$9 = function $$unary() {
      var self = this;

      if ($truthy(self.$consume("+"))) {
        return self.$unary()
      } else if ($truthy(self.$consume("-"))) {
        return self.$unary()['$-@']()
      } else {
        return self.$term()
      }
    }, $ArithmeticEvaluator_unary$9.$$arity = 0);
    
    Opal.def(self, '$term', $ArithmeticEvaluator_term$10 = function $$term() {
      var self = this, ret = nil;

      if ($truthy(self.$consume("("))) {
        
        ret = self.$expr();
        self.$expect(")");
        return ret;
      } else {
        return self.$expect_number()
      }
    }, $ArithmeticEvaluator_term$10.$$arity = 0);
    
    Opal.def(self, '$consume', $ArithmeticEvaluator_consume$11 = function $$consume(str) {
      var self = this;

      
      if ($truthy(self.tokens['$[]'](self.idx)['$!='](str))) {
        return false};
      self.idx = $rb_plus(self.idx, 1);
      return true;
    }, $ArithmeticEvaluator_consume$11.$$arity = 1);
    
    Opal.def(self, '$expect', $ArithmeticEvaluator_expect$12 = function $$expect(str) {
      var self = this;

      
      if ($truthy(self.tokens['$[]'](self.idx)['$!='](str))) {
        self.error = true};
      return (self.idx = $rb_plus(self.idx, 1));
    }, $ArithmeticEvaluator_expect$12.$$arity = 1);
    
    Opal.def(self, '$expect_number', $ArithmeticEvaluator_expect_number$13 = function $$expect_number() {
      var self = this, ret = nil;

      
      if ($truthy(self['$integer?'](self.tokens['$[]'](self.idx)))) {
      } else {
        
        self.error = true;
        self.idx = $rb_plus(self.idx, 1);
        return 0;
      };
      ret = self.tokens['$[]'](self.idx).$to_i();
      self.idx = $rb_plus(self.idx, 1);
      return ret;
    }, $ArithmeticEvaluator_expect_number$13.$$arity = 0);
    return (Opal.def(self, '$integer?', $ArithmeticEvaluator_integer$ques$14 = function(str) {
      var self = this;

      return /^\d+$/.$match(str)['$nil?']()['$!']()
    }, $ArithmeticEvaluator_integer$ques$14.$$arity = 1), nil) && 'integer?';
  })($nesting[0], null, $nesting)
};

/* Generated by Opal 1.0.3 */
Opal.modules["utils/modifier_formatter"] = function(Opal) {
  function $rb_gt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs > rhs : lhs['$>'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $module = Opal.module, $truthy = Opal.truthy;

  Opal.add_stubs(['$==', '$>', '$to_s']);
  return (function($base, $parent_nesting) {
    var self = $module($base, 'ModifierFormatter');

    var $nesting = [self].concat($parent_nesting), $ModifierFormatter_format_modifier$1;

    
    Opal.def(self, '$format_modifier', $ModifierFormatter_format_modifier$1 = function $$format_modifier(modifier) {
      var self = this;

      if (modifier['$=='](0)) {
        return ""
      } else if ($truthy($rb_gt(modifier, 0))) {
        return "" + "+" + (modifier)
      } else {
        return modifier.$to_s()
      }
    }, $ModifierFormatter_format_modifier$1.$$arity = 1)
  })($nesting[0], $nesting)
};

/* Generated by Opal 1.0.3 */
Opal.modules["diceBot/SwordWorld"] = function(Opal) {
  function $rb_ge(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs >= rhs : lhs['$>='](rhs);
  }
  function $rb_le(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs <= rhs : lhs['$<='](rhs);
  }
  function $rb_minus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs - rhs : lhs['$-'](rhs);
  }
  function $rb_gt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs > rhs : lhs['$>'](rhs);
  }
  function $rb_lt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs < rhs : lhs['$<'](rhs);
  }
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_times(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs * rhs : lhs['$*'](rhs);
  }
  function $rb_divide(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs / rhs : lhs['$/'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $send = Opal.send, $truthy = Opal.truthy, $hash2 = Opal.hash2;

  Opal.add_stubs(['$require', '$include', '$setPrefixes', '$freeze', '$match', '$gsub', '$last_match', '$>=', '$<=', '$!=', '$==', '$rating', '$private', '$debug', '$getRatingCommandStrings', '$[]', '$include?', '$getRateUpFromString', '$getCriticalFromString', '$getDiceChangesFromString', '$getKeyAndAddValueFromString', '$=~', '$to_i', '$getSW2_0_RatingTable', '$-', '$length', '$>', '$getNewRates', '$<', '$+', '$getAdditionalString', '$to_s', '$loop', '$rollDice', '$<<', '$getAdditionalDiceValue', '$min', '$*', '$getResultText', '$parren_killer', '$each', '$split', '$push', '$[]=', '$roll', '$join', '$size', '$format_modifier', '$first', '$ceil', '$/', '$===']);
  
  self.$require("utils/modifier_formatter");
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'SwordWorld');

    var $nesting = [self].concat($parent_nesting), $SwordWorld_initialize$1, $SwordWorld_changeText$2, $SwordWorld_getRatingCommandStrings$7, $SwordWorld_check_2D6$8, $SwordWorld_rollDiceCommand$9, $SwordWorld_rating$10, $SwordWorld_getAdditionalString$12, $SwordWorld_getAdditionalDiceValue$13, $SwordWorld_getCriticalFromString$14, $SwordWorld_getDiceChangesFromString$15, $SwordWorld_getRateUpFromString$16, $SwordWorld_getKeyAndAddValueFromString$17, $SwordWorld_getSW2_0_RatingTable$18, $SwordWorld_getNewRates$19, $SwordWorld_rollDice$21, $SwordWorld_getResultText$22, $SwordWorld_setRatingTable$23;

    self.$$prototype.rating_table = nil;
    
    self.$include($$($nesting, 'ModifierFormatter'));
    Opal.const_set($nesting[0], 'ID', "SwordWorld");
    Opal.const_set($nesting[0], 'NAME', "ソードワールドRPG");
    Opal.const_set($nesting[0], 'SORT_KEY', "そおとわあると");
    Opal.const_set($nesting[0], 'HELP_MESSAGE', "・SW　レーティング表　(Kx[c]+m$f) (x:キー, c:クリティカル値, m:ボーナス, f:出目修正)\n");
    self.$setPrefixes(["H?K\\d+.*"]);
    
    Opal.def(self, '$initialize', $SwordWorld_initialize$1 = function $$initialize() {
      var $iter = $SwordWorld_initialize$1.$$p, $yield = $iter || nil, self = this, rating_table = nil;

      if ($iter) $SwordWorld_initialize$1.$$p = null;
      
      rating_table = 0;
      $send(self, Opal.find_super_dispatcher(self, 'initialize', $SwordWorld_initialize$1, false), [], null);
      return (self.rating_table = rating_table);
    }, $SwordWorld_initialize$1.$$arity = 0);
    Opal.const_set($nesting[0], 'RATING_TABLE_RE_FOR_CHANGE_TEXT', /^S?H?K\d+/i.$freeze());
    
    Opal.def(self, '$changeText', $SwordWorld_changeText$2 = function $$changeText(string) {
      var $$3, $$4, $$5, $$6, self = this;

      
      if ($truthy($$($nesting, 'RATING_TABLE_RE_FOR_CHANGE_TEXT').$match(string))) {
      } else {
        return string
      };
      return $send($send($send($send(string, 'gsub', [/\[(\d+)\]/], ($$3 = function(){var self = $$3.$$s || this;

      return "" + "c[" + ($$($nesting, 'Regexp').$last_match(1)) + "]"}, $$3.$$s = self, $$3.$$arity = 0, $$3)), 'gsub', [/@(\d+)/], ($$4 = function(){var self = $$4.$$s || this;

      return "" + "c[" + ($$($nesting, 'Regexp').$last_match(1)) + "]"}, $$4.$$s = self, $$4.$$arity = 0, $$4)), 'gsub', [/\$([-+]?\d+)/], ($$5 = function(){var self = $$5.$$s || this;

      return "" + "m[" + ($$($nesting, 'Regexp').$last_match(1)) + "]"}, $$5.$$s = self, $$5.$$arity = 0, $$5)), 'gsub', [/r([-+]?\d+)/i], ($$6 = function(){var self = $$6.$$s || this;

      return "" + "r[" + ($$($nesting, 'Regexp').$last_match(1)) + "]"}, $$6.$$s = self, $$6.$$arity = 0, $$6));
    }, $SwordWorld_changeText$2.$$arity = 1);
    
    Opal.def(self, '$getRatingCommandStrings', $SwordWorld_getRatingCommandStrings$7 = function $$getRatingCommandStrings() {
      var self = this;

      return "cmCM"
    }, $SwordWorld_getRatingCommandStrings$7.$$arity = 0);
    
    Opal.def(self, '$check_2D6', $SwordWorld_check_2D6$8 = function $$check_2D6(total, dice_total, _dice_list, cmp_op, target) {
      var $a, self = this;

      if ($truthy($rb_ge(dice_total, 12))) {
        return " ＞ 自動的成功"
      } else if ($truthy($rb_le(dice_total, 2))) {
        return " ＞ 自動的失敗"
      } else if ($truthy(($truthy($a = cmp_op['$!='](">=")) ? $a : target['$==']("?")))) {
        return ""
      } else if ($truthy($rb_ge(total, target))) {
        return " ＞ 成功"
      } else {
        return " ＞ 失敗"
      }
    }, $SwordWorld_check_2D6$8.$$arity = 5);
    
    Opal.def(self, '$rollDiceCommand', $SwordWorld_rollDiceCommand$9 = function $$rollDiceCommand(command) {
      var self = this;

      return self.$rating(command)
    }, $SwordWorld_rollDiceCommand$9.$$arity = 1);
    self.$private();
    
    Opal.def(self, '$rating', $SwordWorld_rating$10 = function $$rating(string) {
      var $a, $b, $$11, self = this, commands = nil, m = nil, half = nil, rateUp = nil, crit = nil, firstDiceChanteTo = nil, firstDiceChangeModify = nil, key = nil, addValue = nil, rate_sw2_0 = nil, keyMax = nil, newRates = nil, output = nil, values = nil, diceResultTotals = nil, diceResults = nil, rateResults = nil, dice = nil, diceOnlyTotal = nil, totalValue = nil, round = nil;

      
      self.$debug("rating string", string);
      commands = self.$getRatingCommandStrings();
      m = new RegExp("" + "^S?(H?K[\\d\\+\\-]+([" + (commands) + "]\\[([\\d\\+\\-]+)\\])*([\\d\\+\\-]*)([CMR]\\[([\\d\\+\\-]+)\\]|GF|H)*)", 'i').$match(string);
      if ($truthy(m)) {
      } else {
        
        self.$debug("not matched");
        return "1";
      };
      string = m['$[]'](1);
      half = string['$include?']("H");
      $b = self.$getRateUpFromString(string), $a = Opal.to_ary($b), (rateUp = ($a[0] == null ? nil : $a[0])), (string = ($a[1] == null ? nil : $a[1])), $b;
      $b = self.$getCriticalFromString(string, half), $a = Opal.to_ary($b), (crit = ($a[0] == null ? nil : $a[0])), (string = ($a[1] == null ? nil : $a[1])), $b;
      $b = self.$getDiceChangesFromString(string), $a = Opal.to_ary($b), (firstDiceChanteTo = ($a[0] == null ? nil : $a[0])), (firstDiceChangeModify = ($a[1] == null ? nil : $a[1])), (string = ($a[2] == null ? nil : $a[2])), $b;
      $b = self.$getKeyAndAddValueFromString(string), $a = Opal.to_ary($b), (key = ($a[0] == null ? nil : $a[0])), (addValue = ($a[1] == null ? nil : $a[1])), $b;
      if ($truthy(key['$=~'](/([\d]+)/))) {
      } else {
        return "1"
      };
      key = $$($nesting, 'Regexp').$last_match(1).$to_i();
      rate_sw2_0 = self.$getSW2_0_RatingTable();
      keyMax = $rb_minus(rate_sw2_0.$length(), 1);
      self.$debug("keyMax", keyMax);
      if ($truthy($rb_gt(key, keyMax))) {
        return "" + "キーナンバーは" + (keyMax) + "までです"};
      newRates = self.$getNewRates(rate_sw2_0);
      output = "" + "KeyNo." + (key);
      if ($truthy($rb_lt(crit, 13))) {
        output = $rb_plus(output, "" + "c[" + (crit) + "]")};
      if ($truthy(firstDiceChangeModify['$!='](0))) {
        output = $rb_plus(output, "" + "m[" + (firstDiceChangeModify) + "]")};
      if ($truthy(firstDiceChanteTo['$!='](0))) {
        output = $rb_plus(output, "" + "m[" + (firstDiceChanteTo) + "]")};
      if ($truthy(rateUp['$!='](0))) {
        output = $rb_plus(output, "" + "r[" + (rateUp) + "]")};
      $b = self.$getAdditionalString(string, output), $a = Opal.to_ary($b), (output = ($a[0] == null ? nil : $a[0])), (values = ($a[1] == null ? nil : $a[1])), $b;
      self.$debug("output", output);
      if ($truthy(addValue['$!='](0))) {
        
        if ($truthy($rb_gt(addValue, 0))) {
          output = $rb_plus(output, "" + "+" + (addValue))};
        if ($truthy($rb_lt(addValue, 0))) {
          output = $rb_plus(output, addValue.$to_s())};};
      output = $rb_plus(output, " ＞ ");
      diceResultTotals = [];
      diceResults = [];
      rateResults = [];
      dice = 0;
      diceOnlyTotal = 0;
      totalValue = 0;
      round = 0;
      (function(){var $brk = Opal.new_brk(); try {return $send(self, 'loop', [], ($$11 = function(){var self = $$11.$$s || this, $c, $d, dice_raw = nil, diceText = nil, currentKey = nil, rateValue = nil;

      
        $d = self.$rollDice(values), $c = Opal.to_ary($d), (dice_raw = ($c[0] == null ? nil : $c[0])), (diceText = ($c[1] == null ? nil : $c[1])), $d;
        dice = dice_raw;
        if ($truthy(firstDiceChanteTo['$!='](0))) {
          
          dice = (dice_raw = firstDiceChanteTo);
          firstDiceChanteTo = 0;
        } else if ($truthy(firstDiceChangeModify['$!='](0))) {
          
          dice = $rb_plus(dice, firstDiceChangeModify.$to_i());
          firstDiceChangeModify = 0;};
        if ($truthy($rb_le(dice_raw, 2))) {
          
          diceResultTotals['$<<'](dice_raw.$to_s());
          diceResults['$<<'](diceText.$to_s());
          rateResults['$<<']("**");
          round = $rb_plus(round, 1);
          
          Opal.brk(nil, $brk);};
        dice = $rb_plus(dice, self.$getAdditionalDiceValue(dice, values));
        if ($truthy($rb_lt(dice, 2))) {
          dice = 2};
        if ($truthy($rb_gt(dice, 12))) {
          dice = 12};
        currentKey = [$rb_plus(key, $rb_times(round, rateUp)), keyMax].$min();
        self.$debug("currentKey", currentKey);
        rateValue = newRates['$[]'](dice)['$[]'](currentKey);
        self.$debug("rateValue", rateValue);
        totalValue = $rb_plus(totalValue, rateValue);
        diceOnlyTotal = $rb_plus(diceOnlyTotal, dice);
        diceResultTotals['$<<'](dice.$to_s());
        diceResults['$<<'](diceText.$to_s());
        rateResults['$<<']((function() {if ($truthy($rb_gt(dice, 2))) {
          return rateValue
        } else {
          return "**"
        }; return nil; })());
        round = $rb_plus(round, 1);
        if ($truthy($rb_ge(dice, crit))) {
          return nil
        } else {
          
          Opal.brk(nil, $brk)
        };}, $$11.$$s = self, $$11.$$brk = $brk, $$11.$$arity = 0, $$11))
      } catch (err) { if (err === $brk) { return err.$v } else { throw err } }})();
      output = $rb_plus(output, self.$getResultText(totalValue, addValue, diceResults, diceResultTotals, rateResults, diceOnlyTotal, round, half));
      return output;
    }, $SwordWorld_rating$10.$$arity = 1);
    
    Opal.def(self, '$getAdditionalString', $SwordWorld_getAdditionalString$12 = function $$getAdditionalString(_string, output) {
      var self = this, values = nil;

      
      values = $hash2([], {});
      return [output, values];
    }, $SwordWorld_getAdditionalString$12.$$arity = 2);
    
    Opal.def(self, '$getAdditionalDiceValue', $SwordWorld_getAdditionalDiceValue$13 = function $$getAdditionalDiceValue(_dice, _values) {
      var self = this;

      return 0
    }, $SwordWorld_getAdditionalDiceValue$13.$$arity = 2);
    
    Opal.def(self, '$getCriticalFromString', $SwordWorld_getCriticalFromString$14 = function $$getCriticalFromString(string, half) {
      var self = this, crit = nil, regexp = nil;

      
      crit = (function() {if ($truthy(half)) {
        return 13
      } else {
        return 10
      }; return nil; })();
      regexp = /c\[(\d+)\]/i;
      if ($truthy(regexp['$=~'](string))) {
        
        crit = $$($nesting, 'Regexp').$last_match(1).$to_i();
        if ($truthy($rb_lt(crit, 3))) {
          crit = 3};
        string = string.$gsub(regexp, "");};
      return [crit, string];
    }, $SwordWorld_getCriticalFromString$14.$$arity = 2);
    
    Opal.def(self, '$getDiceChangesFromString', $SwordWorld_getDiceChangesFromString$15 = function $$getDiceChangesFromString(string) {
      var self = this, firstDiceChanteTo = nil, firstDiceChangeModify = nil, regexp = nil;

      
      firstDiceChanteTo = 0;
      firstDiceChangeModify = 0;
      regexp = /m\[([\d\+\-]+)\]/i;
      if ($truthy(regexp['$=~'](string))) {
        
        firstDiceChangeModify = $$($nesting, 'Regexp').$last_match(1);
        if ($truthy(/[\+\-]/['$=~'](firstDiceChangeModify))) {
        } else {
          
          firstDiceChanteTo = firstDiceChangeModify.$to_i();
          firstDiceChangeModify = 0;
        };
        string = string.$gsub(regexp, "");};
      return [firstDiceChanteTo, firstDiceChangeModify, string];
    }, $SwordWorld_getDiceChangesFromString$15.$$arity = 1);
    
    Opal.def(self, '$getRateUpFromString', $SwordWorld_getRateUpFromString$16 = function $$getRateUpFromString(string) {
      var self = this, rateUp = nil;

      
      rateUp = 0;
      return [rateUp, string];
    }, $SwordWorld_getRateUpFromString$16.$$arity = 1);
    
    Opal.def(self, '$getKeyAndAddValueFromString', $SwordWorld_getKeyAndAddValueFromString$17 = function $$getKeyAndAddValueFromString(string) {
      var self = this, key = nil, addValue = nil;

      
      key = nil;
      addValue = 0;
      if ($truthy(/K(\d+)([\d\+\-]*)/i['$=~'](string))) {
        
        key = $$($nesting, 'Regexp').$last_match(1);
        if ($truthy($$($nesting, 'Regexp').$last_match(2))) {
          addValue = self.$parren_killer($rb_plus($rb_plus("(", $$($nesting, 'Regexp').$last_match(2)), ")")).$to_i()};
      } else {
        key = string
      };
      return [key, addValue];
    }, $SwordWorld_getKeyAndAddValueFromString$17.$$arity = 1);
    
    Opal.def(self, '$getSW2_0_RatingTable', $SwordWorld_getSW2_0_RatingTable$18 = function $$getSW2_0_RatingTable() {
      var self = this, rate_sw2_0 = nil;

      
      rate_sw2_0 = ["*,0,0,0,1,2,2,3,3,4,4", "*,0,0,0,1,2,3,3,3,4,4", "*,0,0,0,1,2,3,4,4,4,4", "*,0,0,1,1,2,3,4,4,4,5", "*,0,0,1,2,2,3,4,4,5,5", "*,0,1,1,2,2,3,4,5,5,5", "*,0,1,1,2,3,3,4,5,5,5", "*,0,1,1,2,3,4,4,5,5,6", "*,0,1,2,2,3,4,4,5,6,6", "*,0,1,2,3,3,4,4,5,6,7", "*,1,1,2,3,3,4,5,5,6,7", "*,1,2,2,3,3,4,5,6,6,7", "*,1,2,2,3,4,4,5,6,6,7", "*,1,2,3,3,4,4,5,6,7,7", "*,1,2,3,4,4,4,5,6,7,8", "*,1,2,3,4,4,5,5,6,7,8", "*,1,2,3,4,4,5,6,7,7,8", "*,1,2,3,4,5,5,6,7,7,8", "*,1,2,3,4,5,6,6,7,7,8", "*,1,2,3,4,5,6,7,7,8,9", "*,1,2,3,4,5,6,7,8,9,10", "*,1,2,3,4,6,6,7,8,9,10", "*,1,2,3,5,6,6,7,8,9,10", "*,2,2,3,5,6,7,7,8,9,10", "*,2,3,4,5,6,7,7,8,9,10", "*,2,3,4,5,6,7,8,8,9,10", "*,2,3,4,5,6,8,8,9,9,10", "*,2,3,4,6,6,8,8,9,9,10", "*,2,3,4,6,6,8,9,9,10,10", "*,2,3,4,6,7,8,9,9,10,10", "*,2,4,4,6,7,8,9,10,10,10", "*,2,4,5,6,7,8,9,10,10,11", "*,3,4,5,6,7,8,10,10,10,11", "*,3,4,5,6,8,8,10,10,10,11", "*,3,4,5,6,8,9,10,10,11,11", "*,3,4,5,7,8,9,10,10,11,12", "*,3,5,5,7,8,9,10,11,11,12", "*,3,5,6,7,8,9,10,11,12,12", "*,3,5,6,7,8,10,10,11,12,13", "*,4,5,6,7,8,10,11,11,12,13", "*,4,5,6,7,9,10,11,11,12,13", "*,4,6,6,7,9,10,11,12,12,13", "*,4,6,7,7,9,10,11,12,13,13", "*,4,6,7,8,9,10,11,12,13,14", "*,4,6,7,8,10,10,11,12,13,14", "*,4,6,7,9,10,10,11,12,13,14", "*,4,6,7,9,10,10,12,13,13,14", "*,4,6,7,9,10,11,12,13,13,15", "*,4,6,7,9,10,12,12,13,13,15", "*,4,6,7,10,10,12,12,13,14,15", "*,4,6,8,10,10,12,12,13,15,15", "*,5,7,8,10,10,12,12,13,15,15", "*,5,7,8,10,11,12,12,13,15,15", "*,5,7,9,10,11,12,12,14,15,15", "*,5,7,9,10,11,12,13,14,15,16", "*,5,7,10,10,11,12,13,14,16,16", "*,5,8,10,10,11,12,13,15,16,16", "*,5,8,10,11,11,12,13,15,16,17", "*,5,8,10,11,12,12,13,15,16,17", "*,5,9,10,11,12,12,14,15,16,17", "*,5,9,10,11,12,13,14,15,16,18", "*,5,9,10,11,12,13,14,16,17,18", "*,5,9,10,11,13,13,14,16,17,18", "*,5,9,10,11,13,13,15,17,17,18", "*,5,9,10,11,13,14,15,17,17,18", "*,5,9,10,12,13,14,15,17,18,18", "*,5,9,10,12,13,15,15,17,18,19", "*,5,9,10,12,13,15,16,17,19,19", "*,5,9,10,12,14,15,16,17,19,19", "*,5,9,10,12,14,16,16,17,19,19", "*,5,9,10,12,14,16,17,18,19,19", "*,5,9,10,13,14,16,17,18,19,20", "*,5,9,10,13,15,16,17,18,19,20", "*,5,9,10,13,15,16,17,19,20,21", "*,6,9,10,13,15,16,18,19,20,21", "*,6,9,10,13,16,16,18,19,20,21", "*,6,9,10,13,16,17,18,19,20,21", "*,6,9,10,13,16,17,18,20,21,22", "*,6,9,10,13,16,17,19,20,22,23", "*,6,9,10,13,16,18,19,20,22,23", "*,6,9,10,13,16,18,20,21,22,23", "*,6,9,10,13,17,18,20,21,22,23", "*,6,9,10,14,17,18,20,21,22,24", "*,6,9,11,14,17,18,20,21,23,24", "*,6,9,11,14,17,19,20,21,23,24", "*,6,9,11,14,17,19,21,22,23,24", "*,7,10,11,14,17,19,21,22,23,25", "*,7,10,12,14,17,19,21,22,24,25", "*,7,10,12,14,18,19,21,22,24,25", "*,7,10,12,15,18,19,21,22,24,26", "*,7,10,12,15,18,19,21,23,25,26", "*,7,11,13,15,18,19,21,23,25,26", "*,7,11,13,15,18,20,21,23,25,27", "*,8,11,13,15,18,20,22,23,25,27", "*,8,11,13,16,18,20,22,23,25,28", "*,8,11,14,16,18,20,22,23,26,28", "*,8,11,14,16,19,20,22,23,26,28", "*,8,12,14,16,19,20,22,24,26,28", "*,8,12,15,16,19,20,22,24,27,28", "*,8,12,15,17,19,20,22,24,27,29", "*,8,12,15,18,19,20,22,24,27,30"];
      return rate_sw2_0;
    }, $SwordWorld_getSW2_0_RatingTable$18.$$arity = 0);
    
    Opal.def(self, '$getNewRates', $SwordWorld_getNewRates$19 = function $$getNewRates(rate_sw2_0) {
      var $$20, self = this, rate_3 = nil, rate_4 = nil, rate_5 = nil, rate_6 = nil, rate_7 = nil, rate_8 = nil, rate_9 = nil, rate_10 = nil, rate_11 = nil, rate_12 = nil, zeroArray = nil, $writer = nil, newRates = nil;

      
      rate_3 = [];
      rate_4 = [];
      rate_5 = [];
      rate_6 = [];
      rate_7 = [];
      rate_8 = [];
      rate_9 = [];
      rate_10 = [];
      rate_11 = [];
      rate_12 = [];
      zeroArray = [];
      $send(rate_sw2_0, 'each', [], ($$20 = function(rateText){var self = $$20.$$s || this, rate_arr = nil;

      
        
        if (rateText == null) {
          rateText = nil;
        };
        rate_arr = rateText.$split(/,/);
        zeroArray.$push(0);
        rate_3.$push(rate_arr['$[]'](1).$to_i());
        rate_4.$push(rate_arr['$[]'](2).$to_i());
        rate_5.$push(rate_arr['$[]'](3).$to_i());
        rate_6.$push(rate_arr['$[]'](4).$to_i());
        rate_7.$push(rate_arr['$[]'](5).$to_i());
        rate_8.$push(rate_arr['$[]'](6).$to_i());
        rate_9.$push(rate_arr['$[]'](7).$to_i());
        rate_10.$push(rate_arr['$[]'](8).$to_i());
        rate_11.$push(rate_arr['$[]'](9).$to_i());
        return rate_12.$push(rate_arr['$[]'](10).$to_i());}, $$20.$$s = self, $$20.$$arity = 1, $$20));
      if (self.rating_table['$=='](1)) {
        
        $writer = [31, (($writer = [32, (($writer = [33, 10]), $send(rate_12, '[]=', Opal.to_a($writer)), $writer[$rb_minus($writer["length"], 1)])]), $send(rate_12, '[]=', Opal.to_a($writer)), $writer[$rb_minus($writer["length"], 1)])];
        $send(rate_12, '[]=', Opal.to_a($writer));
        $writer[$rb_minus($writer["length"], 1)];};
      newRates = [zeroArray, zeroArray, zeroArray, rate_3, rate_4, rate_5, rate_6, rate_7, rate_8, rate_9, rate_10, rate_11, rate_12];
      return newRates;
    }, $SwordWorld_getNewRates$19.$$arity = 1);
    
    Opal.def(self, '$rollDice', $SwordWorld_rollDice$21 = function $$rollDice(_values) {
      var $a, $b, self = this, dice = nil, diceText = nil;

      
      $b = self.$roll(2, 6), $a = Opal.to_ary($b), (dice = ($a[0] == null ? nil : $a[0])), (diceText = ($a[1] == null ? nil : $a[1])), $b;
      return [dice, diceText];
    }, $SwordWorld_rollDice$21.$$arity = 1);
    
    Opal.def(self, '$getResultText', $SwordWorld_getResultText$22 = function $$getResultText(rating_total, modifier, diceResults, diceResultTotals, rateResults, dice_total, round, half) {
      var $a, self = this, sequence = nil, text = nil, round_text = nil, total = nil, total_text = nil;

      
      sequence = [];
      sequence.$push("" + "2D:[" + (diceResults.$join(" ")) + "]=" + (diceResultTotals.$join(",")));
      if ($truthy($rb_le(dice_total, 2))) {
        
        sequence.$push(rateResults.$join(","));
        sequence.$push("自動的失敗");
        return sequence.$join(" ＞ ");};
      if ($truthy(($truthy($a = $rb_gt(rateResults.$size(), 1)) ? $a : modifier['$!='](0)))) {
        
        text = $rb_plus(rateResults.$join(","), self.$format_modifier(modifier));
        if ($truthy(half)) {
          text = "" + "(" + (text) + ")/2"};
        sequence.$push(text);
      } else if ($truthy(half)) {
        sequence.$push("" + (rateResults.$first()) + "/2")};
      if ($truthy($rb_gt(round, 1))) {
        
        round_text = "" + ($rb_minus(round, 1)) + "回転";
        sequence.$push(round_text);};
      total = $rb_plus(rating_total, modifier);
      if ($truthy(half)) {
        total = $rb_divide(total, 2.0).$ceil()};
      total_text = total.$to_s();
      sequence.$push(total_text);
      return sequence.$join(" ＞ ");
    }, $SwordWorld_getResultText$22.$$arity = 8);
    return (Opal.def(self, '$setRatingTable', $SwordWorld_setRatingTable$23 = function $$setRatingTable(tnick) {
      var self = this, mode_str = nil, pre_mode = nil, $case = nil;

      
      mode_str = "";
      pre_mode = self.rating_table;
      if ($truthy(/(\d+)/['$=~'](tnick))) {
        
        self.rating_table = $$($nesting, 'Regexp').$last_match(1).$to_i();
        if ($truthy($rb_gt(self.rating_table, 1))) {
          
          mode_str = "2.0-mode";
          self.rating_table = 2;
        } else if ($truthy($rb_gt(self.rating_table, 0))) {
          
          mode_str = "new-mode";
          self.rating_table = 1;
        } else {
          
          mode_str = "old-mode";
          self.rating_table = 0;
        };
      } else {
        $case = tnick;
        if (/old/i['$===']($case)) {
        self.rating_table = 0;
        mode_str = "old-mode";}
        else if (/new/i['$===']($case)) {
        self.rating_table = 1;
        mode_str = "new-mode";}
        else if (/2\.0/i['$===']($case)) {
        self.rating_table = 2;
        mode_str = "2.0-mode";}
      };
      if (self.rating_table['$=='](pre_mode)) {
        return "1"};
      return "" + "RatingTableを" + (mode_str) + "に変更しました";
    }, $SwordWorld_setRatingTable$23.$$arity = 1), nil) && 'setRatingTable';
  })($nesting[0], $$($nesting, 'DiceBot'), $nesting);
};

/* Generated by Opal 1.0.3 */
Opal.modules["diceBot/SwordWorld2_0"] = function(Opal) {
  function $rb_lt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs < rhs : lhs['$<'](rhs);
  }
  function $rb_ge(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs >= rhs : lhs['$>='](rhs);
  }
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_minus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs - rhs : lhs['$-'](rhs);
  }
  function $rb_times(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs * rhs : lhs['$*'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $truthy = Opal.truthy, $send = Opal.send;

  Opal.add_stubs(['$require', '$setPrefixes', '$include', '$format_modifier', '$node_expression', '$<', '$roll_2d6', '$==', '$!', '$>=', '$sum_of_dice', '$last', '$push', '$+', '$compact', '$dice_str', '$result_str', '$length', '$join', '$private', '$reduce', '$flatten', '$to_proc', '$map', '$send', '$new', '$[]', '$roll', '$freeze', '$===', '$=~', '$growth', '$to_i', '$last_match', '$eval', '$execute', '$get_fumble_table', '$get_tangle_table', '$gsub', '$getGratestFortuneFromString', '$[]=', '$-', '$*', '$growth_step', '$get_ability_by_dice', '$!=', '$get_table_by_1d6']);
  
  self.$require("utils/ArithmeticEvaluator");
  self.$require("utils/modifier_formatter");
  self.$require("diceBot/SwordWorld");
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'SwordWorld2_0');

    var $nesting = [self].concat($parent_nesting), $SwordWorld2_0_initialize$10, $SwordWorld2_0_rollDiceCommand$11, $SwordWorld2_0_getRateUpFromString$12, $SwordWorld2_0_getAdditionalString$13, $SwordWorld2_0_rollDice$14, $SwordWorld2_0_getGratestFortuneFromString$15, $SwordWorld2_0_growth$16, $SwordWorld2_0_growth_step$18, $SwordWorld2_0_get_ability_by_dice$19, $SwordWorld2_0_get_fumble_table$20, $SwordWorld2_0_get_tangle_table$21;

    
    Opal.const_set($nesting[0], 'ID', "SwordWorld2.0");
    Opal.const_set($nesting[0], 'NAME', "ソードワールド2.0");
    Opal.const_set($nesting[0], 'SORT_KEY', "そおとわあると2.0");
    Opal.const_set($nesting[0], 'HELP_MESSAGE', "" + "自動的成功、成功、失敗、自動的失敗の自動判定を行います。\n" + "\n" + "・レーティング表　(Kx)\n" + "　\"Kキーナンバー+ボーナス\"の形で記入します。\n" + "　ボーナスの部分に「K20+K30」のようにレーティングを取ることは出来ません。\n" + "　また、ボーナスは複数取ることが出来ます。\n" + "　レーティング表もダイスロールと同様に、他のプレイヤーに隠れてロールすることも可能です。\n" + "　例）K20　　　K10+5　　　k30　　　k10+10　　　Sk10-1　　　k10+5+2\n" + "\n" + "・クリティカル値の設定\n" + "　クリティカル値は\"[クリティカル値]\"で指定します。\n" + "　指定しない場合はクリティカル値10とします。\n" + "　クリティカル処理が必要ないときは13などとしてください。(防御時などの対応)\n" + "　またタイプの軽減化のために末尾に「@クリティカル値」でも処理するようにしました。\n" + "　例）K20[10]　　　K10+5[9]　　　k30[10]　　　k10[9]+10　　　k10-5@9\n" + "\n" + "・レーティング表の半減 (HKx)\n" + "　レーティング表の先頭または末尾に\"H\"をつけると、レーティング表を振って最終結果を半減させます。\n" + "　クリティカル値を指定しない場合、クリティカルなしと扱われます。\n" + "　例）HK20　　K20h　　HK10-5@9　　K10-5@9H　　K20gfH\n" + "\n" + "・ダイス目の修正（運命変転やクリティカルレイ用）\n" + "　末尾に「$修正値」でダイス目に修正がかかります。\n" + "　$＋１と修正表記ならダイス目に＋修正、＄９のように固定値ならダイス目をその出目に差し替え。\n" + "　クリティカルした場合でも固定値や修正値の適用は最初の一回だけです。\n" + "　例）K20$+1　　　K10+5$9　　　k10-5@9$+2　　　k10[9]+10$9\n" + "\n" + "・首切り刀用レーティング上昇 r10\n" + "　例）K20r10　K30+24@8R10　K40+24@8$12r10\n" + "\n" + "・グレイテストフォーチュンは末尾に gf\n" + "　例）K20gf　K30+24@8GF　K40+24@8$12r10gf\n" + "\n" + "・超越判定用に2d6ロールに 2D6@10 書式でクリティカル値付与が可能に。\n" + "　例）2D6@10　2D6@10+11>=30\n" + "\n" + "・成長　(Gr)\n" + "　末尾に数字を付加することで、複数回の成長をまとめて行えます。\n" + "　例）Gr3\n" + "\n" + "・防御ファンブル表　(FT)\n" + "　防御ファンブル表を出すことができます。\n" + "\n" + "・絡み効果表　(TT)\n" + "　絡み効果表を出すことができます。\n");
    self.$setPrefixes(["H?K\\d+.*", "Gr(\\d+)?", "2D6?@\\d+.*", "FT", "TT"]);
    (function($base, $super, $parent_nesting) {
      var self = $klass($base, $super, 'TranscendentTest');

      var $nesting = [self].concat($parent_nesting), $TranscendentTest_initialize$1, $TranscendentTest_execute$2, $TranscendentTest_node_expression$3, $TranscendentTest_sum_of_dice$4, $TranscendentTest_dice_str$5, $TranscendentTest_result_str$7, $TranscendentTest_roll_2d6$8;

      self.$$prototype.modifier = self.$$prototype.critical_value = self.$$prototype.expression = self.$$prototype.modifier_str = self.$$prototype.target = self.$$prototype.cmp_op = nil;
      
      self.$include($$($nesting, 'ModifierFormatter'));
      
      Opal.def(self, '$initialize', $TranscendentTest_initialize$1 = function $$initialize(critical_value, modifier, cmp_op, target) {
        var self = this;

        
        self.critical_value = critical_value;
        self.modifier = modifier;
        self.cmp_op = cmp_op;
        self.target = target;
        self.modifier_str = self.$format_modifier(self.modifier);
        return (self.expression = self.$node_expression());
      }, $TranscendentTest_initialize$1.$$arity = 4);
      
      Opal.def(self, '$execute', $TranscendentTest_execute$2 = function $$execute(bot) {
        var $a, self = this, first_value_group = nil, value_groups = nil, fumble = nil, critical = nil, sum = nil, total_sum = nil, parts = nil;

        
        if ($truthy($rb_lt(self.critical_value, 3))) {
          return "" + "(" + (self.expression) + ") ＞ クリティカル値が小さすぎます。3以上を指定してください。"};
        first_value_group = self.$roll_2d6(bot);
        value_groups = [first_value_group];
        fumble = first_value_group['$==']([1, 1]);
        critical = first_value_group['$==']([6, 6]);
        if ($truthy(($truthy($a = fumble['$!']()) ? critical['$!']() : $a))) {
          while ($truthy($rb_ge(self.$sum_of_dice(value_groups.$last()), self.critical_value))) {
            value_groups.$push(self.$roll_2d6(bot))
          }};
        sum = self.$sum_of_dice(value_groups);
        total_sum = $rb_plus(sum, self.modifier);
        parts = ["" + "(" + (self.expression) + ")", "" + (self.$dice_str(value_groups, sum)) + (self.modifier_str), total_sum, ($truthy($a = self.target) ? self.$result_str(total_sum, value_groups.$length(), fumble, critical) : $a)].$compact();
        return parts.$join(" ＞ ");
      }, $TranscendentTest_execute$2.$$arity = 1);
      self.$private();
      
      Opal.def(self, '$node_expression', $TranscendentTest_node_expression$3 = function $$node_expression() {
        var self = this, lhs = nil;

        
        lhs = "" + "2D6@" + (self.critical_value) + (self.modifier_str);
        return (function() {if ($truthy(self.target)) {
          return "" + (lhs) + (self.cmp_op) + (self.target)
        } else {
          return lhs
        }; return nil; })();
      }, $TranscendentTest_node_expression$3.$$arity = 0);
      
      Opal.def(self, '$sum_of_dice', $TranscendentTest_sum_of_dice$4 = function $$sum_of_dice(value_groups) {
        var self = this;

        return $send(value_groups.$flatten(), 'reduce', [0], "+".$to_proc())
      }, $TranscendentTest_sum_of_dice$4.$$arity = 1);
      
      Opal.def(self, '$dice_str', $TranscendentTest_dice_str$5 = function $$dice_str(value_groups, sum) {
        var $$6, self = this, value_groups_str = nil;

        
        value_groups_str = $send(value_groups, 'map', [], ($$6 = function(values){var self = $$6.$$s || this;

        
          
          if (values == null) {
            values = nil;
          };
          return "" + "[" + (values.$join(",")) + "]";}, $$6.$$s = self, $$6.$$arity = 1, $$6)).$join();
        return "" + (sum) + (value_groups_str);
      }, $TranscendentTest_dice_str$5.$$arity = 2);
      
      Opal.def(self, '$result_str', $TranscendentTest_result_str$7 = function $$result_str(total_sum, n_value_groups, fumble, critical) {
        var $a, self = this;

        
        if ($truthy(fumble)) {
          return "自動的失敗"};
        if ($truthy(critical)) {
          return "自動的成功"};
        if ($truthy(total_sum.$send(self.cmp_op, self.target))) {
          if ($truthy(($truthy($a = $rb_ge(n_value_groups, 2)) ? $rb_ge(total_sum, 41) : $a))) {
            return "超成功"
          } else {
            return "成功"
          }
        } else {
          return "失敗"
        };
      }, $TranscendentTest_result_str$7.$$arity = 4);
      return (Opal.def(self, '$roll_2d6', $TranscendentTest_roll_2d6$8 = function $$roll_2d6(bot) {
        var $$9, self = this;

        return $send($$($nesting, 'Array'), 'new', [2], ($$9 = function(){var self = $$9.$$s || this;

        return bot.$roll(1, 6)['$[]'](0)}, $$9.$$s = self, $$9.$$arity = 0, $$9))
      }, $TranscendentTest_roll_2d6$8.$$arity = 1), nil) && 'roll_2d6';
    })($nesting[0], null, $nesting);
    
    Opal.def(self, '$initialize', $SwordWorld2_0_initialize$10 = function $$initialize() {
      var $iter = $SwordWorld2_0_initialize$10.$$p, $yield = $iter || nil, self = this, rating_table = nil;

      if ($iter) $SwordWorld2_0_initialize$10.$$p = null;
      
      rating_table = 2;
      $send(self, Opal.find_super_dispatcher(self, 'initialize', $SwordWorld2_0_initialize$10, false), [], null);
      return (self.rating_table = rating_table);
    }, $SwordWorld2_0_initialize$10.$$arity = 0);
    Opal.const_set($nesting[0], 'TRANSCENDENT_TEST_RE', /^2D6?@(\d+)([-+\d]+)?(?:(>=?)(\d+))?/.$freeze());
    
    Opal.def(self, '$rollDiceCommand', $SwordWorld2_0_rollDiceCommand$11 = function $$rollDiceCommand(command) {
      var $a, $iter = $SwordWorld2_0_rollDiceCommand$11.$$p, $yield = $iter || nil, self = this, $case = nil, m = nil, critical_value = nil, modifier = nil, cmp_op = nil, target = nil, node = nil;

      if ($iter) $SwordWorld2_0_rollDiceCommand$11.$$p = null;
      return (function() {$case = command;
      if (/^Gr(\d+)?/i['$===']($case)) {if ($truthy(command['$=~'](/^Gr(\d+)/i))) {
        return self.$growth($$($nesting, 'Regexp').$last_match(1).$to_i())
      } else {
        return self.$growth()
      }}
      else if ($$($nesting, 'TRANSCENDENT_TEST_RE')['$===']($case)) {
      m = $$($nesting, 'Regexp').$last_match();
      critical_value = m['$[]'](1).$to_i();
      modifier = (function() {if ($truthy(m['$[]'](2))) {
        return $$($nesting, 'ArithmeticEvaluator').$new().$eval(m['$[]'](2))
      } else {
        return 0
      }; return nil; })();
      cmp_op = m['$[]'](3);
      target = ($truthy($a = m['$[]'](3)) ? m['$[]'](4).$to_i() : $a);
      node = $$($nesting, 'TranscendentTest').$new(critical_value, modifier, cmp_op, target);
      return node.$execute(self);}
      else if ("FT"['$===']($case)) {return self.$get_fumble_table()}
      else if ("TT"['$===']($case)) {return self.$get_tangle_table()}
      else {return $send(self, Opal.find_super_dispatcher(self, 'rollDiceCommand', $SwordWorld2_0_rollDiceCommand$11, false), [command], null)}})()
    }, $SwordWorld2_0_rollDiceCommand$11.$$arity = 1);
    
    Opal.def(self, '$getRateUpFromString', $SwordWorld2_0_getRateUpFromString$12 = function $$getRateUpFromString(string) {
      var self = this, rateUp = nil, regexp = nil;

      
      rateUp = 0;
      regexp = /r\[(\d+)\]/i;
      if ($truthy(regexp['$==='](string))) {
        
        rateUp = $$($nesting, 'Regexp').$last_match(1).$to_i();
        string = string.$gsub(regexp, "");};
      return [rateUp, string];
    }, $SwordWorld2_0_getRateUpFromString$12.$$arity = 1);
    
    Opal.def(self, '$getAdditionalString', $SwordWorld2_0_getAdditionalString$13 = function $$getAdditionalString(string, output) {
      var $a, $b, $iter = $SwordWorld2_0_getAdditionalString$13.$$p, $yield = $iter || nil, self = this, values = nil, isGratestFortune = nil, $writer = nil;

      if ($iter) $SwordWorld2_0_getAdditionalString$13.$$p = null;
      
      $b = $send(self, Opal.find_super_dispatcher(self, 'getAdditionalString', $SwordWorld2_0_getAdditionalString$13, false), [string, output], null), $a = Opal.to_ary($b), (output = ($a[0] == null ? nil : $a[0])), (values = ($a[1] == null ? nil : $a[1])), $b;
      $b = self.$getGratestFortuneFromString(string), $a = Opal.to_ary($b), (isGratestFortune = ($a[0] == null ? nil : $a[0])), (string = ($a[1] == null ? nil : $a[1])), $b;
      
      $writer = ["isGratestFortune", isGratestFortune];
      $send(values, '[]=', Opal.to_a($writer));
      $writer[$rb_minus($writer["length"], 1)];;
      if ($truthy(isGratestFortune)) {
        output = $rb_plus(output, "gf")};
      return [output, values];
    }, $SwordWorld2_0_getAdditionalString$13.$$arity = 2);
    
    Opal.def(self, '$rollDice', $SwordWorld2_0_rollDice$14 = function $$rollDice(values) {
      var $a, $b, $iter = $SwordWorld2_0_rollDice$14.$$p, $yield = $iter || nil, self = this, dice = nil, diceText = nil;

      if ($iter) $SwordWorld2_0_rollDice$14.$$p = null;
      
      if ($truthy(values['$[]']("isGratestFortune"))) {
      } else {
        return $send(self, Opal.find_super_dispatcher(self, 'rollDice', $SwordWorld2_0_rollDice$14, false), [values], null)
      };
      $b = self.$roll(1, 6), $a = Opal.to_ary($b), (dice = ($a[0] == null ? nil : $a[0])), (diceText = ($a[1] == null ? nil : $a[1])), $b;
      dice = $rb_times(dice, 2);
      diceText = "" + (diceText) + "," + (diceText);
      return [dice, diceText];
    }, $SwordWorld2_0_rollDice$14.$$arity = 1);
    
    Opal.def(self, '$getGratestFortuneFromString', $SwordWorld2_0_getGratestFortuneFromString$15 = function $$getGratestFortuneFromString(string) {
      var self = this, isGratestFortune = nil, regexp = nil;

      
      isGratestFortune = false;
      regexp = /gf/i;
      if ($truthy(regexp['$==='](string))) {
        
        isGratestFortune = true;
        string = string.$gsub(regexp, "");};
      return [isGratestFortune, string];
    }, $SwordWorld2_0_getGratestFortuneFromString$15.$$arity = 1);
    
    Opal.def(self, '$growth', $SwordWorld2_0_growth$16 = function $$growth(count) {
      var $$17, self = this;

      
      
      if (count == null) {
        count = 1;
      };
      return $send(Opal.Range.$new(1, count, false), 'map', [], ($$17 = function(){var self = $$17.$$s || this;

      return self.$growth_step()}, $$17.$$s = self, $$17.$$arity = 0, $$17)).$join(" | ");
    }, $SwordWorld2_0_growth$16.$$arity = -1);
    
    Opal.def(self, '$growth_step', $SwordWorld2_0_growth_step$18 = function $$growth_step() {
      var $a, $b, self = this, d1 = nil, d2 = nil, a1 = nil, a2 = nil;

      
      $b = self.$roll(1, 6), $a = Opal.to_ary($b), (d1 = ($a[0] == null ? nil : $a[0])), $b;
      $b = self.$roll(1, 6), $a = Opal.to_ary($b), (d2 = ($a[0] == null ? nil : $a[0])), $b;
      a1 = self.$get_ability_by_dice(d1);
      a2 = self.$get_ability_by_dice(d2);
      return (function() {if ($truthy(a1['$!='](a2))) {
        return "" + "[" + (d1) + "," + (d2) + "]->(" + (a1) + " or " + (a2) + ")"
      } else {
        return "" + "[" + (d1) + "," + (d2) + "]->(" + (a1) + ")"
      }; return nil; })();
    }, $SwordWorld2_0_growth_step$18.$$arity = 0);
    
    Opal.def(self, '$get_ability_by_dice', $SwordWorld2_0_get_ability_by_dice$19 = function $$get_ability_by_dice(dice) {
      var self = this;

      return ["器用度", "敏捷度", "筋力", "生命力", "知力", "精神力"]['$[]']($rb_minus(dice, 1))
    }, $SwordWorld2_0_get_ability_by_dice$19.$$arity = 1);
    
    Opal.def(self, '$get_fumble_table', $SwordWorld2_0_get_fumble_table$20 = function $$get_fumble_table() {
      var $a, $b, self = this, table = nil, text = nil, num = nil;

      
      table = ["この表を2回振り、その両方を適用する。（同じ出目による影響は累積しない）。この自動失敗により得られる経験点は、+50点される", "ダメージに、攻撃者を強化している「剣のかけら」の数が追加される", "ダメージに、攻撃者の「レベル」が追加される", "ダメージ決定を2回行い、より高い方を採用する", "合算ダメージを2倍する", "防護点無効"];
      $b = self.$get_table_by_1d6(table), $a = Opal.to_ary($b), (text = ($a[0] == null ? nil : $a[0])), (num = ($a[1] == null ? nil : $a[1])), $b;
      return "" + "防御ファンブル表(" + (num) + ") → " + (text);
    }, $SwordWorld2_0_get_fumble_table$20.$$arity = 0);
    return (Opal.def(self, '$get_tangle_table', $SwordWorld2_0_get_tangle_table$21 = function $$get_tangle_table() {
      var $a, $b, self = this, table = nil, text = nil, num = nil;

      
      table = ["頭や顔：牙や噛みつきなどにおける命中力判定及び、魔法の行使やブレスに-2のペナルティ修正を受ける", "武器や盾：武器の使用不可、又は盾の回避力修正及び防護点を無効化する", "腕や手：武器や爪などにおける命中力判定に-2のペナルティ修正、盾を持つ腕方の腕ならその盾の回避力修正及び防護点を無効化する", "脚や足：移動不可、更に回避力判定に-2のペナルティ修正を受ける ※両足に絡んでも累積しない", "胴体：生命・精神抵抗力を基準値に用いる判定を除き、あらゆる行為判定に-1のペナルティ修正を受ける", "特殊：尻尾や翼などに命中。絡められた部位を使用する判定において-2のペナルティ修正、またはそこが使えていたことによるボーナス修正を失う ※存在しない場合は決め直し"];
      $b = self.$get_table_by_1d6(table), $a = Opal.to_ary($b), (text = ($a[0] == null ? nil : $a[0])), (num = ($a[1] == null ? nil : $a[1])), $b;
      return "" + "絡み効果表(" + (num) + ") → " + (text);
    }, $SwordWorld2_0_get_tangle_table$21.$$arity = 0), nil) && 'get_tangle_table';
  })($nesting[0], $$($nesting, 'SwordWorld'), $nesting);
};

/* Generated by Opal 1.0.3 */
(function(Opal) {
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_minus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs - rhs : lhs['$-'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $truthy = Opal.truthy, $send = Opal.send;

  Opal.add_stubs(['$require', '$setPrefixes', '$match', '$gsub', '$to_i', '$last_match', '$format_modifier', '$+', '$getKeptDiceChangesFromString', '$[]=', '$-', '$!=', '$[]', '$=~']);
  
  self.$require("diceBot/SwordWorld2_0");
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'SwordWorld2_5');

    var $nesting = [self].concat($parent_nesting), $SwordWorld2_5_changeText$1, $SwordWorld2_5_getRatingCommandStrings$3, $SwordWorld2_5_getAdditionalString$4, $SwordWorld2_5_getAdditionalDiceValue$5, $SwordWorld2_5_getKeptDiceChangesFromString$6;

    
    Opal.const_set($nesting[0], 'ID', "SwordWorld2.5");
    Opal.const_set($nesting[0], 'NAME', "ソードワールド2.5");
    Opal.const_set($nesting[0], 'SORT_KEY', "そおとわあると2.5");
    Opal.const_set($nesting[0], 'HELP_MESSAGE', "" + "自動的成功、成功、失敗、自動的失敗の自動判定を行います。\n" + "\n" + "・レーティング表　(Kx)\n" + "　\"Kキーナンバー+ボーナス\"の形で記入します。\n" + "　ボーナスの部分に「K20+K30」のようにレーティングを取ることは出来ません。\n" + "　また、ボーナスは複数取ることが出来ます。\n" + "　レーティング表もダイスロールと同様に、他のプレイヤーに隠れてロールすることも可能です。\n" + "　例）K20　　　K10+5　　　k30　　　k10+10　　　Sk10-1　　　k10+5+2\n" + "\n" + "・クリティカル値の設定\n" + "　クリティカル値は\"[クリティカル値]\"で指定します。\n" + "　指定しない場合はクリティカル値10とします。\n" + "　クリティカル処理が必要ないときは13などとしてください。(防御時などの対応)\n" + "　またタイプの軽減化のために末尾に「@クリティカル値」でも処理するようにしました。\n" + "　例）K20[10]　　　K10+5[9]　　　k30[10]　　　k10[9]+10　　　k10-5@9\n" + "\n" + "・レーティング表の半減 (HKx)\n" + "　レーティング表の先頭または末尾に\"H\"をつけると、レーティング表を振って最終結果を半減させます。\n" + "　クリティカル値を指定しない場合、クリティカルなしと扱われます。\n" + "　例）HK20　　K20h　　HK10-5@9　　K10-5@9H　　K20gfH\n" + "\n" + "・ダイス目の修正（運命変転やクリティカルレイ用）\n" + "　末尾に「$修正値」でダイス目に修正がかかります。\n" + "　$＋１と修正表記ならダイス目に＋修正、＄９のように固定値ならダイス目をその出目に差し替え。\n" + "　クリティカルした場合でも固定値や修正値の適用は最初の一回だけです。\n" + "　例）K20$+1　　　K10+5$9　　　k10-5@9$+2　　　k10[9]+10$9\n" + "\n" + "・ダイス目の修正（必殺攻撃用）\n" + "　「＃修正値」でダイス目に修正がかかります。\n" + "　クリティカルした場合でも修正値の適用は継続されます。\n" + "　例）K20#1　　　k10-5@9#2\n" + "\n" + "・首切り刀用レーティング上昇 r10\n" + "　例）K20r10　K30+24@8R10　K40+24@8$12r10\n" + "\n" + "・グレイテストフォーチュンは末尾に gf\n" + "　例）K20gf　K30+24@8GF　K40+24@8$12r10gf\n" + "\n" + "・超越判定用に2d6ロールに 2D6@10 書式でクリティカル値付与が可能に。\n" + "　例）2D6@10　2D6@10+11>=30\n" + "\n" + "・成長　(Gr)\n" + "　末尾に数字を付加することで、複数回の成長をまとめて行えます。\n" + "　例）Gr3\n" + "\n" + "・防御ファンブル表　(FT)\n" + "　防御ファンブル表を出すことができます。\n" + "\n" + "・絡み効果表　(TT)\n" + "　絡み効果表を出すことができます。\n");
    self.$setPrefixes(["H?K\\d+.*", "Gr(\\d+)?", "2D6?@\\d+.*", "FT", "TT"]);
    
    Opal.def(self, '$changeText', $SwordWorld2_5_changeText$1 = function $$changeText(string) {
      var $$2, $iter = $SwordWorld2_5_changeText$1.$$p, $yield = $iter || nil, self = this;

      if ($iter) $SwordWorld2_5_changeText$1.$$p = null;
      
      if ($truthy($$($nesting, 'RATING_TABLE_RE_FOR_CHANGE_TEXT').$match(string))) {
      } else {
        return string
      };
      return $send($send(self, Opal.find_super_dispatcher(self, 'changeText', $SwordWorld2_5_changeText$1, false), [string], null), 'gsub', [/#([-+]?\d+)/], ($$2 = function(){var self = $$2.$$s || this, modifier = nil;

      
        modifier = $$($nesting, 'Regexp').$last_match(1).$to_i();
        return "" + "a[" + (self.$format_modifier(modifier)) + "]";}, $$2.$$s = self, $$2.$$arity = 0, $$2));
    }, $SwordWorld2_5_changeText$1.$$arity = 1);
    
    Opal.def(self, '$getRatingCommandStrings', $SwordWorld2_5_getRatingCommandStrings$3 = function $$getRatingCommandStrings() {
      var $iter = $SwordWorld2_5_getRatingCommandStrings$3.$$p, $yield = $iter || nil, self = this, $zuper = nil, $zuper_i = nil, $zuper_ii = nil;

      if ($iter) $SwordWorld2_5_getRatingCommandStrings$3.$$p = null;
      // Prepare super implicit arguments
      for($zuper_i = 0, $zuper_ii = arguments.length, $zuper = new Array($zuper_ii); $zuper_i < $zuper_ii; $zuper_i++) {
        $zuper[$zuper_i] = arguments[$zuper_i];
      }
      return $rb_plus($send(self, Opal.find_super_dispatcher(self, 'getRatingCommandStrings', $SwordWorld2_5_getRatingCommandStrings$3, false), $zuper, $iter), "aA")
    }, $SwordWorld2_5_getRatingCommandStrings$3.$$arity = 0);
    
    Opal.def(self, '$getAdditionalString', $SwordWorld2_5_getAdditionalString$4 = function $$getAdditionalString(string, output) {
      var $a, $b, $iter = $SwordWorld2_5_getAdditionalString$4.$$p, $yield = $iter || nil, self = this, values = nil, keptDiceChangeModify = nil, $writer = nil;

      if ($iter) $SwordWorld2_5_getAdditionalString$4.$$p = null;
      
      $b = $send(self, Opal.find_super_dispatcher(self, 'getAdditionalString', $SwordWorld2_5_getAdditionalString$4, false), [string, output], null), $a = Opal.to_ary($b), (output = ($a[0] == null ? nil : $a[0])), (values = ($a[1] == null ? nil : $a[1])), $b;
      $b = self.$getKeptDiceChangesFromString(string), $a = Opal.to_ary($b), (keptDiceChangeModify = ($a[0] == null ? nil : $a[0])), (string = ($a[1] == null ? nil : $a[1])), $b;
      
      $writer = ["keptDiceChangeModify", keptDiceChangeModify];
      $send(values, '[]=', Opal.to_a($writer));
      $writer[$rb_minus($writer["length"], 1)];;
      if ($truthy(keptDiceChangeModify['$!='](0))) {
        output = $rb_plus(output, "" + "a[" + (keptDiceChangeModify) + "]")};
      return [output, values];
    }, $SwordWorld2_5_getAdditionalString$4.$$arity = 2);
    
    Opal.def(self, '$getAdditionalDiceValue', $SwordWorld2_5_getAdditionalDiceValue$5 = function $$getAdditionalDiceValue(dice, values) {
      var $a, self = this, keptDiceChangeModify = nil, value = nil;

      
      keptDiceChangeModify = values['$[]']("keptDiceChangeModify").$to_i();
      value = 0;
      if ($truthy(($truthy($a = keptDiceChangeModify['$!='](0)) ? dice['$!='](2) : $a))) {
        value = $rb_plus(value, keptDiceChangeModify.$to_i())};
      return value;
    }, $SwordWorld2_5_getAdditionalDiceValue$5.$$arity = 2);
    return (Opal.def(self, '$getKeptDiceChangesFromString', $SwordWorld2_5_getKeptDiceChangesFromString$6 = function $$getKeptDiceChangesFromString(string) {
      var self = this, keptDiceChangeModify = nil, regexp = nil;

      
      keptDiceChangeModify = 0;
      regexp = /a\[([\+\-]\d+)\]/i;
      if ($truthy(regexp['$=~'](string))) {
        
        keptDiceChangeModify = $$($nesting, 'Regexp').$last_match(1);
        string = string.$gsub(regexp, "");};
      return [keptDiceChangeModify, string];
    }, $SwordWorld2_5_getKeptDiceChangesFromString$6.$$arity = 1), nil) && 'getKeptDiceChangesFromString';
  })($nesting[0], $$($nesting, 'SwordWorld2_0'), $nesting);
})(Opal);
