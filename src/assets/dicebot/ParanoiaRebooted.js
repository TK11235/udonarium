/* Generated by Opal 1.0.3 */
(function(Opal) {
  function $rb_minus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs - rhs : lhs['$-'](rhs);
  }
  function $rb_plus(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs + rhs : lhs['$+'](rhs);
  }
  function $rb_ge(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs >= rhs : lhs['$>='](rhs);
  }
  function $rb_lt(lhs, rhs) {
    return (typeof(lhs) === 'number' && typeof(rhs) === 'number') ? lhs < rhs : lhs['$<'](rhs);
  }
  var self = Opal.top, $nesting = [], nil = Opal.nil, $$$ = Opal.const_get_qualified, $$ = Opal.const_get_relative, $breaker = Opal.breaker, $slice = Opal.slice, $klass = Opal.klass, $send = Opal.send, $truthy = Opal.truthy;

  Opal.add_stubs(['$setPrefixes', '$===', '$get_node_dice_roll', '$get_mutant_power_roll', '$private', '$dup', '$==', '$to_i', '$[]', '$[]=', '$-', '$debug', '$match', '$+', '$abs', '$roll', '$split', '$count', '$>=', '$<', '$generate_roll_results', '$join']);
  return (function($base, $super, $parent_nesting) {
    var self = $klass($base, $super, 'ParanoiaRebooted');

    var $nesting = [self].concat($parent_nesting), $ParanoiaRebooted_rollDiceCommand$1, $ParanoiaRebooted_generate_roll_results$2, $ParanoiaRebooted_get_node_dice_roll$3, $ParanoiaRebooted_get_mutant_power_roll$6;

    
    Opal.const_set($nesting[0], 'ID', "ParanoiaRebooted");
    Opal.const_set($nesting[0], 'NAME', "パラノイア リブーテッド");
    Opal.const_set($nesting[0], 'SORT_KEY', "はらのいありふうてつと");
    Opal.const_set($nesting[0], 'HELP_MESSAGE', "" + "※コマンドは入力内容の前方一致で検出しています。\n" + "・通常の判定　NDx\n" + "　x：ノードダイスの数.マイナスも可.\n" + "　ノードダイスの絶対値 + 1個(コンピュータダイス)のダイスがロールされる.\n" + "例）ND2　ND-3\n" + "\n" + "・ミュータントパワー判定　MPx\n" + "  x：ノードダイスの数.\n" + "　ノードダイスの値 + 1個(コンピュータダイス)のダイスがロールされる.\n" + "例）MP2\n");
    self.$setPrefixes(["ND.*", "MP.*"]);
    
    Opal.def(self, '$rollDiceCommand', $ParanoiaRebooted_rollDiceCommand$1 = function $$rollDiceCommand(command) {
      var self = this, $case = nil;

      return (function() {$case = command;
      if (/^ND/i['$===']($case)) {return self.$get_node_dice_roll(command)}
      else if (/^MP/i['$===']($case)) {return self.$get_mutant_power_roll(command)}
      else {return nil}})()
    }, $ParanoiaRebooted_rollDiceCommand$1.$$arity = 1);
    self.$private();
    
    Opal.def(self, '$generate_roll_results', $ParanoiaRebooted_generate_roll_results$2 = function $$generate_roll_results(dices) {
      var self = this, computer_dice_message = nil, results = nil, $writer = nil;

      
      computer_dice_message = "";
      results = dices.$dup();
      if (results['$[]'](-1).$to_i()['$=='](6)) {
        
        
        $writer = [-1, "C"];
        $send(results, '[]=', Opal.to_a($writer));
        $writer[$rb_minus($writer["length"], 1)];;
        computer_dice_message = "(Computer)";};
      return [results, computer_dice_message];
    }, $ParanoiaRebooted_generate_roll_results$2.$$arity = 1);
    
    Opal.def(self, '$get_node_dice_roll', $ParanoiaRebooted_get_node_dice_roll$3 = function $$get_node_dice_roll(command) {
      var $a, $b, $$4, $$5, self = this, m = nil, parameter_num = nil, dice_count = nil, total = nil, dice_text = nil, dices = nil, success_rate = nil, results = nil, computer_dice_message = nil;

      
      self.$debug("rollDiceCommand Begin");
      m = /^ND((-)?\d+)/i.$match(command);
      if ($truthy(m)) {
      } else {
        return ""
      };
      self.$debug("command", command);
      parameter_num = m['$[]'](1).$to_i();
      dice_count = $rb_plus(parameter_num.$abs(), 1);
      $b = self.$roll(dice_count, 6), $a = Opal.to_ary($b), (total = ($a[0] == null ? nil : $a[0])), (dice_text = ($a[1] == null ? nil : $a[1])), $b;
      dices = dice_text.$split(",");
      success_rate = $send(dices, 'count', [], ($$4 = function(dice){var self = $$4.$$s || this;

      
        
        if (dice == null) {
          dice = nil;
        };
        return $rb_ge(dice.$to_i(), 5);}, $$4.$$s = self, $$4.$$arity = 1, $$4));
      if ($truthy($rb_lt(parameter_num, 0))) {
        success_rate = $rb_minus(success_rate, $send(dices, 'count', [], ($$5 = function(dice){var self = $$5.$$s || this;

        
          
          if (dice == null) {
            dice = nil;
          };
          return $rb_lt(dice.$to_i(), 5);}, $$5.$$s = self, $$5.$$arity = 1, $$5)))};
      self.$debug(dices);
      $b = self.$generate_roll_results(dices), $a = Opal.to_ary($b), (results = ($a[0] == null ? nil : $a[0])), (computer_dice_message = ($a[1] == null ? nil : $a[1])), $b;
      self.$debug("rollDiceCommand result");
      return "" + "(" + (command) + ") ＞ [" + (results.$join(", ")) + "] ＞ 成功度" + (success_rate) + (computer_dice_message);
    }, $ParanoiaRebooted_get_node_dice_roll$3.$$arity = 1);
    return (Opal.def(self, '$get_mutant_power_roll', $ParanoiaRebooted_get_mutant_power_roll$6 = function $$get_mutant_power_roll(command) {
      var $a, $b, $$7, self = this, m = nil, parameter_num = nil, dice_count = nil, total = nil, dice_text = nil, dices = nil, failure_rate = nil, message = nil, results = nil, computer_dice_message = nil;

      
      self.$debug("rollDiceCommand Begin");
      m = /^MP(\d+)/i.$match(command);
      if ($truthy(m)) {
      } else {
        return ""
      };
      self.$debug("command", command);
      parameter_num = m['$[]'](1).$to_i();
      dice_count = $rb_plus(parameter_num.$abs(), 1);
      $b = self.$roll(dice_count, 6), $a = Opal.to_ary($b), (total = ($a[0] == null ? nil : $a[0])), (dice_text = ($a[1] == null ? nil : $a[1])), $b;
      dices = dice_text.$split(",");
      failure_rate = $send(dices, 'count', [], ($$7 = function(dice){var self = $$7.$$s || this;

      
        
        if (dice == null) {
          dice = nil;
        };
        return dice.$to_i()['$=='](1);}, $$7.$$s = self, $$7.$$arity = 1, $$7));
      message = (function() {if (failure_rate['$=='](0)) {
        return "成功"
      } else {
        return "" + "失敗(" + (failure_rate) + ")"
      }; return nil; })();
      $b = self.$generate_roll_results(dices), $a = Opal.to_ary($b), (results = ($a[0] == null ? nil : $a[0])), (computer_dice_message = ($a[1] == null ? nil : $a[1])), $b;
      self.$debug(dices);
      self.$debug("rollDiceCommand result");
      return "" + "(" + (command) + ") ＞ [" + (results.$join(", ")) + "] ＞ " + (message) + (computer_dice_message);
    }, $ParanoiaRebooted_get_mutant_power_roll$6.$$arity = 1), nil) && 'get_mutant_power_roll';
  })($nesting[0], $$($nesting, 'DiceBot'), $nesting)
})(Opal);
